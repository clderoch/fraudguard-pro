<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FraudGuard Pro - AI-Powered Fraud Detection</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- ApexCharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.44.0/apexcharts.min.js"></script>
    
    <style>
        :root {
            --primary-color: #5d87ff;
            --secondary-color: #49beff;
            --success-color: #13deb9;
            --danger-color: #fa896b;
            --warning-color: #ffae1f;
            --info-color: #539bff;
            --light-color: #f5f5f9;
            --dark-color: #2a3547;
            --border-color: #e5eaef;
            --text-muted: #5a6a85;
            --white: #ffffff;
            --sidebar-width: 270px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h4 {
            font-weight: 700;
            margin: 0;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-header h4 {
            opacity: 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-menu i {
            width: 20px;
            margin-right: 15px;
            font-size: 18px;
        }

        .sidebar.collapsed .sidebar-menu a span {
            display: none;
        }

        /* Content Sections */
        .content-sections {
            min-height: calc(100vh - 80px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .analytics-widget {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .upload-area-main {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area-main:hover {
            background: #f0f9ff;
            border-color: #4c6fff !important;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 70px;
        }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header .d-flex {
            align-items: center;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-muted);
            cursor: pointer;
            margin-right: 15px;
        }

        .header-title {
            font-weight: 600;
            margin: 0;
            color: var(--dark-color);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--light-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Dashboard Cards */
        .dashboard-container {
            padding: 30px;
        }

        /* Ensure equal height cards in rows */
        .row {
            display: flex;
            flex-wrap: wrap;
        }

        .row > [class*="col-"] {
            display: flex;
            flex-direction: column;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-card .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-card.primary .card-icon {
            background: rgba(93, 135, 255, 0.1);
            color: var(--primary-color);
        }

        .stat-card.success .card-icon {
            background: rgba(19, 222, 185, 0.1);
            color: var(--success-color);
        }

        .stat-card.danger .card-icon {
            background: rgba(250, 137, 107, 0.1);
            color: var(--danger-color);
        }

        .stat-card.warning .card-icon {
            background: rgba(255, 174, 31, 0.1);
            color: var(--warning-color);
        }

        .stat-card h3 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .stat-card p {
            color: var(--text-muted);
            margin: 0;
            font-size: 14px;
        }

        .stat-card .badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 20px;
            margin-top: auto;
            margin-bottom: 0;
            align-self: flex-start;
        }

        /* Card content structure */
        .stat-card-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .stat-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Chart Cards */
        .chart-card {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-card h5 {
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-color);
            flex-shrink: 0;
        }

        .chart-card > div[id*="Chart"] {
            flex: 1;
            min-height: 300px;
        }

        /* ApexCharts responsive improvements */
        .apexcharts-xaxis-texts-g text {
            font-size: 12px !important;
        }

        .apexcharts-xaxis-label {
            font-size: 11px !important;
        }

        /* For large datasets with many date points */
        @media (max-width: 768px) {
            .apexcharts-xaxis-texts-g text {
                font-size: 10px !important;
            }
        }

        /* Transaction Table */
        .transaction-table {
            background: var(--white);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--dark-color);
            background: var(--light-color);
            padding: 15px;
        }

        .table td {
            padding: 15px;
            vertical-align: middle;
            border-top: 1px solid var(--border-color);
        }

        .risk-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .risk-badge.high {
            background: rgba(250, 137, 107, 0.1);
            color: var(--danger-color);
        }

        .risk-badge.medium {
            background: rgba(255, 174, 31, 0.1);
            color: var(--warning-color);
        }

        .risk-badge.low {
            background: rgba(19, 222, 185, 0.1);
            color: var(--success-color);
        }

        /* Upload Modal */
        .upload-modal {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            max-width: 500px;
            margin: 0 auto;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(93, 135, 255, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(93, 135, 255, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-1px);
        }

        /* AI Assistant */
        .ai-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(93, 135, 255, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .ai-assistant:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(93, 135, 255, 0.6);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .sidebar-header h4 {
                opacity: 0;
            }
        }

        /* Dark Theme */
        .dark-theme {
            --light-color: #1c1f26;
            --white: #2a3547;
            --dark-color: #ffffff;
            --border-color: #3a4553;
            --text-muted: #a6b0cf;
        }

        .dark-theme body {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        /* Analysis Results Styling */
        .analysis-tab {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .risk-factor-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .risk-factor-item:last-child {
            border-bottom: none;
        }

        .recommendation-item {
            padding: 8px 12px;
            background: var(--light-color);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
            font-size: 14px;
        }

        .recommendation-item i {
            margin-right: 8px;
            width: 16px;
        }

        /* Enhanced transaction table */
        .btn-group .btn {
            border-radius: 4px !important;
            margin-right: 2px;
        }

        .btn-group .btn:last-child {
            margin-right: 0;
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Enhanced progress bars */
        .progress {
            border-radius: 10px;
            background-color: var(--border-color);
        }

        .progress-bar {
            border-radius: 10px;
            transition: width 0.6s ease;
        }

        /* Alert improvements */
        .alert-container {
            max-width: 400px;
        }

        .alert {
            box-shadow: var(--shadow-lg);
            border: none;
            border-radius: var(--radius-lg);
        }

        /* Modal improvements */
        .modal-content {
            border-radius: var(--radius-xl);
            border: none;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* Button hover effects */
        .btn:hover {
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Enhanced tooltips */
        [title] {
            position: relative;
        }

        /* Safety Score Enhancements */
        .safety-score-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .safety-score-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .safety-score-info {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            backdrop-filter: blur(10px);
        }

        .safety-score-breakdown {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .safety-score-breakdown .d-flex {
            padding: 2px 0;
        }

        /* Safety Score Guide */
        .safety-score-guide {
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            font-size: 0.8rem;
        }

        .score-ranges {
            background: white;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #f1f5f9;
        }

        .score-range-item {
            border-bottom: 1px solid #f8fafc;
            padding: 3px 0;
        }

        .score-range-item:last-child {
            border-bottom: none;
        }

        .score-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .score-color-indicator.bg-success {
            background-color: #13deb9 !important;
        }

        .score-color-indicator.bg-warning {
            background-color: #ffae1f !important;
        }

        .score-color-indicator.bg-info {
            background-color: #ff9f43 !important;
        }

        .score-color-indicator.bg-danger {
            background-color: #fa896b !important;
        }

        /* Inline Score Reference Bar */
        .score-reference-bar {
            margin: 15px 0;
        }

        .score-bar-container {
            position: relative;
            height: 25px;
            margin-bottom: 5px;
        }

        .score-bar {
            display: flex;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }

        .score-segment {
            height: 100%;
            transition: all 0.3s ease;
        }

        .score-segment.score-danger {
            background: linear-gradient(90deg, #fa896b 0%, #ff6b6b 100%);
        }

        .score-segment.score-fair {
            background: linear-gradient(90deg, #ff9f43 0%, #ffa726 100%);
        }

        .score-segment.score-good {
            background: linear-gradient(90deg, #ffae1f 0%, #ffc107 100%);
        }

        .score-segment.score-excellent {
            background: linear-gradient(90deg, #13deb9 0%, #00d4aa 100%);
        }

        .score-indicator {
            position: absolute;
            top: -2px;
            transform: translateX(-50%);
            z-index: 10;
        }

        .score-pointer {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #2a3547;
            margin: 0 auto;
            position: relative;
        }

        .score-pointer::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -4px;
            width: 8px;
            height: 8px;
            background: #2a3547;
            border-radius: 50%;
        }

        .score-value {
            display: block;
            text-align: center;
            font-weight: bold;
            color: #2a3547;
            margin-top: 2px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 4px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        .score-labels {
            font-size: 0.7rem;
            margin-top: 3px;
        }

        /* Pulse animation for critical scores */
        .safety-score-critical {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Responsive improvements */
        @media (max-width: 992px) {
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                margin-bottom: 2px;
                margin-right: 0;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }
            
            .stat-card, .chart-card, .transaction-table {
                padding: 15px;
            }
            
            /* Ensure cards maintain equal height on mobile */
            .row > [class*="col-"] {
                margin-bottom: 15px;
            }
            
            .stat-card {
                min-height: 140px;
            }
            
            .table-responsive {
                font-size: 14px;
            }
            
            /* Safety Score Mobile Adjustments */
            .safety-score-guide {
                font-size: 0.75rem;
            }
            
            .score-reference-bar {
                margin: 10px 0;
            }
            
            .score-bar-container {
                height: 20px;
            }
            
            .score-bar {
                height: 10px;
            }
            
            .score-value {
                font-size: 0.65rem;
            }
            
            .score-labels {
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-shield-alt"></i> FraudGuard Pro</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-section="dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
            <li><a href="#" data-section="upload" class="nav-link"><i class="fas fa-upload"></i> <span>Upload Data</span></a></li>
            <li><a href="#" data-section="analytics" class="nav-link"><i class="fas fa-chart-line"></i> <span>Analytics</span></a></li>
            <li><a href="#" data-section="alerts" class="nav-link"><i class="fas fa-exclamation-triangle"></i> <span>Alerts</span></a></li>
            <li><a href="#" data-section="history" class="nav-link"><i class="fas fa-history"></i> <span>Transaction History</span></a></li>
            <li><a href="#" data-section="settings" class="nav-link"><i class="fas fa-cogs"></i> <span>Settings</span></a></li>
            <li><a href="#" data-section="help" class="nav-link"><i class="fas fa-question-circle"></i> <span>Help</span></a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h5 class="header-title">Fraud Detection Dashboard</h5>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> Admin
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user-circle"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cogs"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <div class="content-sections">
            
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
                <div class="dashboard-container">
                    <!-- Stats Row -->
                    <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card primary">
                        <div class="stat-card-content">
                            <div class="card-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="stat-card-body">
                                <div>
                                    <h3 data-stat="total">12,847</h3>
                                    <p>Total Transactions</p>
                                </div>
                                <span class="badge bg-success" data-badge="total">100% processed successfully</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card danger">
                        <div class="stat-card-content">
                            <div class="card-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-card-body">
                                <div>
                                    <h3 data-stat="attention">156</h3>
                                    <p>Need Attention</p>
                                </div>
                                <span class="badge bg-danger" data-badge="attention">0% of total transactions</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card success">
                        <div class="stat-card-content">
                            <div class="card-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="stat-card-body">
                                <div>
                                    <h3 data-stat="safe">12,691</h3>
                                    <p>Safe Payments</p>
                                </div>
                                <span class="badge bg-success" data-badge="safe">0% of total transactions</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="stat-card warning">
                        <div class="stat-card-content">
                            <div class="card-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-card-body">
                                <div>
                                    <h3 data-stat="risk">$0.00</h3>
                                    <p>Money at Risk</p>
                                </div>
                                <span class="badge bg-warning" data-badge="risk">Monitor closely</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-xl-8">
                    <div class="chart-card">
                        <h5><i class="fas fa-chart-line"></i> Transaction Analysis by Date</h5>
                        <div id="fraudTrendsChart"></div>
                    </div>
                </div>
                <div class="col-xl-4">
                    <div class="chart-card">
                        <h5><i class="fas fa-chart-pie"></i> Risk Distribution</h5>
                        <div id="riskDistributionChart"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="row">
                <div class="col-12">
                    <div class="transaction-table">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="fas fa-list"></i> Recent Transactions</h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" id="exportBtn" style="display: none;">
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                    <i class="fas fa-upload"></i> Upload Data
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Transaction ID</th>
                                        <th>Amount</th>
                                        <th>Customer / Merchant</th>
                                        <th>Risk Score</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody">
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                <span class="fw-bold">#TXN001</span>
                                            </div>
                                        </td>
                                        <td><span class="fw-bold">$2,450.00</span></td>
                                        <td>
                                            <div>
                                                <div class="fw-medium">Tech Store Inc</div>
                                                <small class="text-muted">Electronics</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 80px; height: 8px;">
                                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 85%"></div>
                                                </div>
                                                <small class="text-danger fw-bold">85%</small>
                                            </div>
                                        </td>
                                        <td><span class="risk-badge high">High Risk</span></td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Flag">
                                                    <i class="fas fa-flag"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" title="Block">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-shield-alt me-2 text-success"></i>
                                                <span class="fw-bold">#TXN002</span>
                                            </div>
                                        </td>
                                        <td><span class="fw-bold">$89.99</span></td>
                                        <td>
                                            <div>
                                                <div class="fw-medium">Coffee Shop</div>
                                                <small class="text-muted">Food & Beverage</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 80px; height: 8px;">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 15%"></div>
                                                </div>
                                                <small class="text-success fw-bold">15%</small>
                                            </div>
                                        </td>
                                        <td><span class="risk-badge low">Low Risk</span></td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-eye me-2 text-warning"></i>
                                                <span class="fw-bold">#TXN003</span>
                                            </div>
                                        </td>
                                        <td><span class="fw-bold">$567.20</span></td>
                                        <td>
                                            <div>
                                                <div class="fw-medium">Online Retailer</div>
                                                <small class="text-muted">E-commerce</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 80px; height: 8px;">
                                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 45%"></div>
                                                </div>
                                                <small class="text-warning fw-bold">45%</small>
                                            </div>
                                        </td>
                                        <td><span class="risk-badge medium">Medium Risk</span></td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Flag">
                                                    <i class="fas fa-flag"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Results Section (Hidden by default) -->
            <div id="analysisResults" style="display: none;">
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="fas fa-chart-bar"></i> Fraud Analysis Summary</h5>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="switchAnalysisView('overview')">
                                        <i class="fas fa-chart-pie"></i> Overview
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="switchAnalysisView('details')">
                                        <i class="fas fa-list-alt"></i> Details
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="switchAnalysisView('patterns')">
                                        <i class="fas fa-search"></i> Patterns
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Overview Tab -->
                            <div id="analysisOverview" class="analysis-tab">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6>Risk Distribution</h6>
                                            <div id="miniRiskChart" style="height: 200px;"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6>Top Risk Factors</h6>
                                            <div id="riskFactors">
                                                <div class="risk-factor-item">
                                                    <span class="badge bg-danger">High Amount</span>
                                                    <span class="float-end">23%</span>
                                                </div>
                                                <div class="risk-factor-item">
                                                    <span class="badge bg-warning">Unusual Time</span>
                                                    <span class="float-end">18%</span>
                                                </div>
                                                <div class="risk-factor-item">
                                                    <span class="badge bg-info">New Customer</span>
                                                    <span class="float-end">15%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h6>Recommendations</h6>
                                            <div class="recommendations">
                                                <div class="recommendation-item">
                                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                                    Review 3 high-risk transactions
                                                </div>
                                                <div class="recommendation-item">
                                                    <i class="fas fa-phone text-info"></i>
                                                    Contact 2 customers for verification
                                                </div>
                                                <div class="recommendation-item">
                                                    <i class="fas fa-shield-alt text-success"></i>
                                                    Enable velocity checking
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Details Tab -->
                            <div id="analysisDetails" class="analysis-tab" style="display: none;">
                                <!-- Simplified Risk Overview for Small Merchants -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="fas fa-shield-alt text-primary me-2"></i>
                                            Your Transaction Safety Overview
                                        </h5>
                                        <p class="text-muted">Easy-to-understand insights about your transactions</p>
                                    </div>
                                </div>
                                
                                <!-- Risk Score Meter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card h-100 safety-score-card">
                                            <div class="card-body text-center">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="card-title mb-0">
                                                        <i class="fas fa-tachometer-alt text-info me-2"></i>
                                                        Overall Safety Score
                                                    </h6>
                                                    <button class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" 
                                                            title="Safety Score Calculation:
• Base score from safe transaction percentage
• Penalty for high-risk transactions (-5 points each, max -30)
• Penalty for watch transactions (-2 points each, max -15)  
• Penalty for money at risk (-2 points per $1000, max -20)
• Final score ranges: 85-100 (Excellent), 70-84 (Good), 50-69 (Fair), 0-49 (Needs Attention)"
                                                            data-bs-html="true">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                </div>
                                                <div id="safetyScoreMeter" style="height: 200px;"></div>
                                                
                                                <!-- Safety Score Reference Guide -->
                                                <div class="safety-score-guide mt-3 mb-2">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <small class="text-muted fw-bold">Safety Score Guide:</small>
                                                        <button class="btn btn-sm btn-outline-secondary" 
                                                                data-bs-toggle="collapse" 
                                                                data-bs-target="#scoreGuideDetails" 
                                                                aria-expanded="false">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                    <div class="collapse" id="scoreGuideDetails">
                                                        <div class="score-ranges">
                                                            <div class="score-range-item d-flex justify-content-between align-items-center py-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="score-color-indicator bg-success me-2"></div>
                                                                    <small class="fw-medium">85-100</small>
                                                                </div>
                                                                <small class="text-success">Excellent</small>
                                                            </div>
                                                            <div class="score-range-item d-flex justify-content-between align-items-center py-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="score-color-indicator bg-warning me-2"></div>
                                                                    <small class="fw-medium">70-84</small>
                                                                </div>
                                                                <small class="text-warning">Good</small>
                                                            </div>
                                                            <div class="score-range-item d-flex justify-content-between align-items-center py-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="score-color-indicator bg-info me-2"></div>
                                                                    <small class="fw-medium">50-69</small>
                                                                </div>
                                                                <small class="text-info">Fair</small>
                                                            </div>
                                                            <div class="score-range-item d-flex justify-content-between align-items-center py-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="score-color-indicator bg-danger me-2"></div>
                                                                    <small class="fw-medium">0-49</small>
                                                                </div>
                                                                <small class="text-danger">Needs Attention</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div id="safetyScoreText" class="mt-2">
                                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                                        <i class="fas fa-shield-alt me-2 text-success"></i>
                                                        <h4 class="mb-0 text-success">Excellent</h4>
                                                    </div>
                                                    <p class="text-muted mb-1">Your payment security is outstanding</p>
                                                    <div class="safety-score-info">
                                                        <div class="safety-score-breakdown">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="text-muted">Safe Transactions:</small>
                                                                <small class="fw-bold text-success">0/0</small>
                                                            </div>
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="text-muted">Safety Rate:</small>
                                                                <small class="fw-bold">100%</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Transaction Safety Breakdown -->
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-chart-pie text-success me-2"></i>
                                                    Transaction Safety Breakdown
                                                </h6>
                                                <div id="safetyBreakdownChart" style="height: 200px;"></div>
                                                <div class="mt-2">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span><i class="fas fa-circle text-success me-1"></i> Safe</span>
                                                        <span id="safePercentage" class="fw-bold">0%</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <span><i class="fas fa-circle text-warning me-1"></i> Watch</span>
                                                        <span id="watchPercentage" class="fw-bold">0%</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span><i class="fas fa-circle text-danger me-1"></i> Risk</span>
                                                        <span id="riskPercentage" class="fw-bold">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- When Do Risky Transactions Happen -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-clock text-warning me-2"></i>
                                                    When Do Risky Transactions Happen?
                                                </h6>
                                                <div id="timeRiskChart" style="height: 220px;"></div>
                                                <p class="text-muted small mt-2">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    Watch for unusual activity during off-hours
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Transaction Amount Risk -->
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="fas fa-dollar-sign text-info me-2"></i>
                                                    Are Large or Small Amounts Riskier?
                                                </h6>
                                                <div id="amountRiskChart" style="height: 220px;"></div>
                                                <p class="text-muted small mt-2">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    <span id="amountRiskInsight">Checking your transaction patterns...</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Action Cards -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h6 class="mb-3">
                                            <i class="fas fa-tasks text-primary me-2"></i>
                                            What You Should Do Next
                                        </h6>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-warning">
                                            <div class="card-body text-center">
                                                <i class="fas fa-eye fa-2x text-warning mb-2"></i>
                                                <h6>Review High-Risk</h6>
                                                <p class="text-muted small">
                                                    <span id="reviewCount">0</span> transactions need your attention
                                                </p>
                                                <button class="btn btn-warning btn-sm" onclick="showHighRiskTransactions()">
                                                    Review Now
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-info">
                                            <div class="card-body text-center">
                                                <i class="fas fa-phone fa-2x text-info mb-2"></i>
                                                <h6>Contact Customers</h6>
                                                <p class="text-muted small">
                                                    Verify <span id="contactCount">0</span> transactions by phone
                                                </p>
                                                <button class="btn btn-info btn-sm" onclick="showContactList()">
                                                    Get Numbers
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-success">
                                            <div class="card-body text-center">
                                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                                <h6>Enable Protection</h6>
                                                <p class="text-muted small">
                                                    Set up automatic monitoring
                                                </p>
                                                <button class="btn btn-success btn-sm" onclick="enableProtection()">
                                                    Turn On
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Simple Transaction List -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-list text-primary me-2"></i>
                                                    Your Transactions (Most Important First)
                                                </h6>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-primary active" onclick="filterTransactions('all')">All</button>
                                                    <button type="button" class="btn btn-outline-warning" onclick="filterTransactions('risk')">Needs Review</button>
                                                    <button type="button" class="btn btn-outline-success" onclick="filterTransactions('safe')">Safe</button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="detailedTransactionsList">
                                                    <!-- Populated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Patterns Tab -->
                            <div id="analysisPatterns" class="analysis-tab" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Time-based Patterns</h6>
                                        <div id="timePatternChart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Amount Distribution</h6>
                                        <div id="amountPatternChart" style="height: 250px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Data Section -->
            <div class="content-section" id="upload-section">
                <div class="dashboard-container">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-upload"></i> Upload Transaction Data</h5>
                                <div class="upload-area-main" style="border: 2px dashed #5d87ff; border-radius: 10px; padding: 60px; text-align: center; margin: 20px 0;">
                                    <h3><i class="fas fa-cloud-upload-alt"></i> Upload CSV File</h3>
                                    <p>Drag and drop your transaction CSV file here or click to browse</p>
                                    <input type="file" id="mainFileInput" accept=".csv" style="display: none;">
                                    <button class="btn btn-primary" onclick="document.getElementById('mainFileInput').click()">
                                        <i class="fas fa-file-csv"></i> Select CSV File
                                    </button>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            Required columns: transaction_id, amount, transaction_date, transaction_time
                                        </small>
                                    </div>
                                </div>
                                <div id="mainUploadStatus"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div class="content-section" id="analytics-section">
                <div class="dashboard-container">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-chart-line"></i> Advanced Analytics</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="analytics-widget">
                                            <h6>Fraud Detection Accuracy</h6>
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-success" style="width: 98.7%">98.7%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="analytics-widget">
                                            <h6>Average Response Time</h6>
                                            <h3 class="text-primary">47ms</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>Fraud Patterns Analysis</h6>
                                        <p>Upload transaction data to see detailed fraud pattern analysis.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alerts Section -->
            <div class="content-section" id="alerts-section">
                <div class="dashboard-container">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-exclamation-triangle"></i> Security Alerts</h5>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No active alerts at this time. Upload transaction data to monitor for fraud patterns.
                                </div>
                                <div class="mt-4">
                                    <h6>Alert Types Monitored:</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check-circle text-success me-2"></i> Unusual transaction amounts</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i> Suspicious geographic patterns</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i> High-frequency transactions</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i> Anomalous time patterns</li>
                                        <li><i class="fas fa-check-circle text-success me-2"></i> Card testing attempts</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transaction History Section -->
            <div class="content-section" id="history-section">
                <div class="dashboard-container">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-history"></i> Transaction History</h5>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <label for="dateRange">Date Range:</label>
                                        <select class="form-select d-inline-block w-auto ms-2" id="dateRange">
                                            <option>Last 7 days</option>
                                            <option>Last 30 days</option>
                                            <option>Last 90 days</option>
                                            <option>Custom range</option>
                                        </select>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-secondary">
                                            <i class="fas fa-filter"></i> Filter
                                        </button>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Upload transaction data to view historical analysis and trends.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="dashboard-container">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-cogs"></i> Settings</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Fraud Detection Sensitivity</h6>
                                        <div class="mb-3">
                                            <label for="sensitivityRange" class="form-label">Risk Threshold</label>
                                            <input type="range" class="form-range" id="sensitivityRange" min="1" max="100" value="70">
                                            <div class="d-flex justify-content-between">
                                                <small>Low</small>
                                                <small>Medium</small>
                                                <small>High</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Notification Settings</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="emailAlerts" checked>
                                            <label class="form-check-label" for="emailAlerts">
                                                Email alerts for high-risk transactions
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="realTimeAlerts" checked>
                                            <label class="form-check-label" for="realTimeAlerts">
                                                Real-time dashboard notifications
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button class="btn btn-primary">Save Settings</button>
                                    <button class="btn btn-outline-secondary ms-2">Reset to Default</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="content-section" id="help-section">
                <div class="dashboard-container">
                    <div class="row">
                        <div class="col-12">
                            <div class="chart-card">
                                <h5><i class="fas fa-question-circle"></i> Help & Support</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Quick Start Guide</h6>
                                        <ol>
                                            <li>Upload your transaction CSV file using the "Upload Data" section</li>
                                            <li>Review the analysis results on the Dashboard</li>
                                            <li>Check high-risk transactions in the Alerts section</li>
                                            <li>Export reports for further analysis</li>
                                        </ol>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>CSV File Format</h6>
                                        <p>Your CSV file should include these columns:</p>
                                        <ul>
                                            <li><strong>transaction_id</strong> - Unique identifier</li>
                                            <li><strong>amount</strong> - Transaction amount</li>
                                            <li><strong>transaction_date</strong> - Date of transaction</li>
                                            <li><strong>transaction_time</strong> - Time of transaction</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h6>Support</h6>
                                    <p>For technical support, please contact: <strong>support@fraudguardpro.com</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Transaction Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: var(--primary-color);"></i>
                        <h6>Drop your CSV file here or click to browse</h6>
                        <p class="text-muted">Supports CSV files up to 10MB</p>
                        <input type="file" id="fileInput" accept=".csv" style="display: none;">
                    </div>
                    <div class="mt-3" id="uploadProgress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="text-muted mt-2">Processing transactions...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadBtn">Upload & Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="aiAssistant">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Sidebar Toggle
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        });

        // Theme Toggle
        document.getElementById('themeToggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-theme');
            const icon = this.querySelector('i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        });

        // Navigation System
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-menu .nav-link');
            const contentSections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetSection = this.getAttribute('data-section');
                    
                    // Remove active class from all nav links
                    navLinks.forEach(navLink => navLink.classList.remove('active'));
                    
                    // Add active class to clicked nav link
                    this.classList.add('active');
                    
                    // Hide all content sections
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    // Show target content section
                    const targetElement = document.getElementById(targetSection + '-section');
                    if (targetElement) {
                        targetElement.classList.add('active');
                        
                        // Update header title based on section
                        const headerTitle = document.querySelector('.header-title');
                        if (headerTitle) {
                            const sectionTitles = {
                                'dashboard': 'Fraud Detection Dashboard',
                                'upload': 'Upload Transaction Data',
                                'analytics': 'Advanced Analytics',
                                'alerts': 'Security Alerts',
                                'history': 'Transaction History',
                                'settings': 'Settings',
                                'help': 'Help & Support'
                            };
                            headerTitle.textContent = sectionTitles[targetSection] || 'FraudGuard Pro';
                        }
                    }
                });
            });
        }

        // Initialize navigation when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeNavigation();
            setupMainUploadArea();
            initializeTooltips();
        });

        // Initialize tooltips
        function initializeTooltips() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        }

        // Setup main upload area functionality
        function setupMainUploadArea() {
            const mainFileInput = document.getElementById('mainFileInput');
            const uploadArea = document.querySelector('.upload-area-main');
            const uploadStatus = document.getElementById('mainUploadStatus');

            if (mainFileInput && uploadArea) {
                // Handle file selection
                mainFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleMainFileUpload(file);
                    }
                });

                // Handle drag and drop
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.style.background = '#e3f2fd';
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.style.background = '';
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.background = '';
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        mainFileInput.files = e.dataTransfer.files;
                        handleMainFileUpload(file);
                    } else {
                        showMainUploadStatus('Please drop a valid CSV file.', 'error');
                    }
                });

                // Click to upload
                uploadArea.addEventListener('click', function() {
                    mainFileInput.click();
                });
            }
        }

        async function handleMainFileUpload(file) {
            const uploadStatus = document.getElementById('mainUploadStatus');
            
            showMainUploadStatus('🔍 Analyzing file...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/analyze-transactions', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                showMainUploadStatus('✅ Analysis completed! Switching to Dashboard view...', 'success');
                
                // Store the analysis data globally
                window.currentAnalysisData = data;
                
                // Switch to dashboard and show results
                setTimeout(() => {
                    const dashboardLink = document.querySelector('[data-section="dashboard"]');
                    if (dashboardLink) {
                        dashboardLink.click();
                    }
                    showAnalysisResults(data);
                }, 2000);
                
            } catch (error) {
                showMainUploadStatus(`❌ Error: ${error.message}`, 'error');
                console.error('Upload error:', error);
            }
        }

        function showMainUploadStatus(message, type = 'info') {
            const uploadStatus = document.getElementById('mainUploadStatus');
            if (uploadStatus) {
                const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
                uploadStatus.innerHTML = `<div class="alert ${alertClass} mt-3">${message}</div>`;
                
                if (type === 'success') {
                    setTimeout(() => {
                        uploadStatus.innerHTML = '';
                    }, 3000);
                }
            }
        }

        // Initialize Charts
        function initializeCharts() {
            // Fraud Trends Chart
            const fraudTrendsOptions = {
                series: [{
                    name: 'Total Transactions',
                    data: [3100, 4000, 2800, 5100, 4200, 3500, 4800, 5200, 3900, 4600, 5800, 6200]
                }, {
                    name: 'Flagged Transactions',
                    data: [50, 80, 45, 95, 75, 60, 85, 90, 70, 80, 100, 110]
                }],
                chart: {
                    height: 350,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#5d87ff', '#fa896b'],
                fill: {
                    type: 'gradient',
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.3
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                xaxis: {
                    categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    labels: {
                        rotate: 0,
                        hideOverlappingLabels: true,
                        maxHeight: 80,
                        style: {
                            fontSize: '12px',
                            fontWeight: 500
                        }
                    },
                    axisBorder: {
                        show: true,
                        color: '#e5eaef'
                    },
                    axisTicks: {
                        show: true,
                        color: '#e5eaef'
                    }
                },
                grid: {
                    borderColor: '#e5eaef'
                }
            };

            const fraudTrendsChart = new ApexCharts(document.querySelector("#fraudTrendsChart"), fraudTrendsOptions);
            window.fraudTrendsChart = fraudTrendsChart; // Store globally for updates
            fraudTrendsChart.render();

            // Risk Distribution Chart
            const riskDistributionOptions = {
                series: [65, 25, 10],
                chart: {
                    type: 'donut',
                    height: 300
                },
                colors: ['#13deb9', '#ffae1f', '#fa896b'],
                labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                legend: {
                    position: 'bottom'
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%'
                        }
                    }
                }
            };

            const riskDistributionChart = new ApexCharts(document.querySelector("#riskDistributionChart"), riskDistributionOptions);
            riskDistributionChart.render();
        }

        // File Upload Handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadProgress = document.getElementById('uploadProgress');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (file) {
                // Check file extension and MIME type more flexibly
                const fileName = file.name.toLowerCase();
                const validExtensions = ['.csv'];
                const validMimeTypes = [
                    'text/csv', 
                    'application/csv', 
                    'text/comma-separated-values',
                    'application/excel',
                    'application/vnd.ms-excel',
                    'text/plain'  // Some systems report CSV as plain text
                ];
                
                const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
                const hasValidMimeType = validMimeTypes.includes(file.type) || file.type === '';
                
                if (hasValidExtension && (hasValidMimeType || file.type === '')) {
                    uploadBtn.textContent = `Upload ${file.name}`;
                    uploadBtn.disabled = false;
                    uploadBtn.dataset.file = file.name;
                    // Store the file for later upload
                    uploadBtn.selectedFile = file;
                    
                    // Update UI
                    uploadArea.querySelector('h6').textContent = `Selected: ${file.name}`;
                    uploadArea.querySelector('p').textContent = 'Ready to upload and analyze';
                } else {
                    alert(`Please select a valid CSV file. \nDetected type: ${file.type}\nFile extension: ${fileName.substring(fileName.lastIndexOf('.'))}`);
                    uploadBtn.disabled = true;
                    uploadBtn.selectedFile = null;
                    fileInput.value = '';  // Clear the input
                }
            } else {
                uploadBtn.disabled = true;
                uploadBtn.selectedFile = null;
            }
        }

        uploadBtn.addEventListener('click', async () => {
            const file = uploadBtn.selectedFile;
            if (!file) {
                alert('Please select a file first.');
                return;
            }

            // Show progress
            uploadProgress.style.display = 'block';
            const progressBar = uploadProgress.querySelector('.progress-bar');
            uploadBtn.disabled = true;
            
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                // Update progress to show starting
                progressBar.style.width = '20%';
                progressBar.textContent = 'Uploading...';

                // Upload file to backend
                const response = await fetch('/api/analyze-transactions', {
                    method: 'POST',
                    body: formData
                });

                progressBar.style.width = '60%';
                progressBar.textContent = 'Analyzing...';

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Complete progress
                progressBar.style.width = '100%';
                progressBar.textContent = 'Complete!';

                // Hide progress after a moment
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    
                    // Update dashboard with results
                    updateDashboardWithResults(data);
                    
                    // Show success message
                    showSuccessMessage(`Successfully analyzed ${data.summary.total_transactions} transactions!`);
                    
                    // Reset button
                    uploadBtn.textContent = 'Upload & Analyze';
                    uploadBtn.disabled = true;
                    uploadBtn.selectedFile = null;
                    fileInput.value = '';
                }, 1000);

            } catch (error) {
                console.error('Upload error:', error);
                progressBar.style.width = '100%';
                progressBar.textContent = 'Error!';
                progressBar.classList.add('bg-danger');
                
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    progressBar.classList.remove('bg-danger');
                    uploadBtn.disabled = false;
                    alert(`Upload failed: ${error.message}`);
                }, 2000);
            }
        });

        function updateDashboardWithResults(data) {
            const summary = data.summary;
            
            // Update stats cards with animation
            animateCounterUpdate('[data-stat="total"]', summary.total_transactions || 0);
            animateCounterUpdate('[data-stat="safe"]', summary.safe_payments || 0);
            animateCounterUpdate('[data-stat="attention"]', summary.needs_attention || 0);
            animateCounterUpdate('[data-stat="risk"]', summary.money_at_risk || 0, true);
            
            // Update badges with meaningful percentages
            updateBadgePercentages(summary);
            
            // Update recent transactions table
            updateRecentTransactionsTable(data.recent_transactions || []);
            
            // Update detailed analysis section
            updateDetailedAnalysis(data);
            
            // Show analysis results tab
            showAnalysisResults(data);
            
            // Refresh charts with new data (with slight delay to ensure containers are visible)
            setTimeout(() => {
                refreshChartsWithData(data);
            }, 100);
        }

        function updateBadgePercentages(summary) {
            // Update Total Transactions badge
            const totalBadge = document.querySelector('[data-badge="total"]');
            if (totalBadge && summary.total_processed_rate !== undefined) {
                totalBadge.textContent = `${summary.total_processed_rate}% processed successfully`;
                totalBadge.className = 'badge bg-success';
            }
            
            // Update Need Attention badge
            const attentionBadge = document.querySelector('[data-badge="attention"]');
            if (attentionBadge && summary.needs_attention_rate !== undefined) {
                attentionBadge.textContent = `${summary.needs_attention_rate}% of total transactions`;
                // Change badge color based on percentage
                if (summary.needs_attention_rate > 10) {
                    attentionBadge.className = 'badge bg-danger';
                } else if (summary.needs_attention_rate > 5) {
                    attentionBadge.className = 'badge bg-warning';
                } else {
                    attentionBadge.className = 'badge bg-success';
                }
            }
            
            // Update Safe Payments badge
            const safeBadge = document.querySelector('[data-badge="safe"]');
            if (safeBadge && summary.safe_payment_rate !== undefined) {
                safeBadge.textContent = `${summary.safe_payment_rate}% of total transactions`;
                safeBadge.className = 'badge bg-success';
            }
            
            // Update Money at Risk badge (keep existing logic for this one)
            const riskBadge = document.querySelector('[data-badge="risk"]');
            if (riskBadge && summary.money_at_risk !== undefined) {
                if (summary.money_at_risk > 1000) {
                    riskBadge.textContent = 'High risk amount';
                    riskBadge.className = 'badge bg-danger';
                } else if (summary.money_at_risk > 100) {
                    riskBadge.textContent = 'Monitor closely';
                    riskBadge.className = 'badge bg-warning';
                } else {
                    riskBadge.textContent = 'Low risk amount';
                    riskBadge.className = 'badge bg-success';
                }
            }
        }

        // Helper function for consistent USD currency formatting
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function animateCounterUpdate(selector, targetValue, isCurrency = false) {
            const element = document.querySelector(selector);
            if (!element) return;
            
            const startValue = parseFloat(element.textContent.replace(/[$,]/g, '')) || 0;
            const duration = 1000; // 1 second
            const startTime = performance.now();
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = startValue + (targetValue - startValue) * easeOutQuart;
                
                if (isCurrency) {
                    // Use the helper function for consistent formatting
                    element.textContent = formatCurrency(currentValue);
                } else {
                    element.textContent = Math.floor(currentValue).toLocaleString();
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }
            
            requestAnimationFrame(updateValue);
        }

        function updateRecentTransactionsTable(transactions) {
            const tableBody = document.querySelector('#transactionTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            
            transactions.slice(0, 10).forEach((tx, index) => {
                const row = document.createElement('tr');
                const riskClass = tx.risk_score > 70 ? 'danger' : tx.risk_score > 40 ? 'warning' : 'success';
                const safetyLevel = tx.safety_level || (tx.risk_score > 70 ? 'High Risk' : tx.risk_score > 40 ? 'Medium Risk' : 'Low Risk');
                const riskIcon = tx.risk_score > 70 ? 'fas fa-exclamation-triangle' : tx.risk_score > 40 ? 'fas fa-eye' : 'fas fa-shield-alt';
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="${riskIcon} me-2 text-${riskClass}"></i>
                            <span class="fw-bold">${tx.transaction_id}</span>
                        </div>
                    </td>
                    <td>
                        <span class="fw-bold">${formatCurrency(parseFloat(tx.amount || 0))}</span>
                    </td>
                    <td>
                        <div>
                            <div class="fw-medium">${tx.customer_name || 'N/A'}</div>
                            <small class="text-muted">${tx.merchant_category || ''}</small>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress me-2" style="width: 80px; height: 8px;">
                                <div class="progress-bar bg-${riskClass}" role="progressbar" 
                                     style="width: ${tx.risk_score}%" 
                                     aria-valuenow="${tx.risk_score}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-${riskClass} fw-bold">${tx.risk_score}</small>
                        </div>
                    </td>
                    <td><span class="risk-badge ${riskClass}">${safetyLevel}</span></td>
                    <td>
                        <div class="btn-group" role="group" aria-label="Transaction actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails('${tx.transaction_id}', ${index})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${tx.risk_score > 40 ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="flagTransaction('${tx.transaction_id}')" title="Flag for Review">
                                    <i class="fas fa-flag"></i>
                                </button>
                            ` : ''}
                            ${tx.risk_score > 70 ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="blockTransaction('${tx.transaction_id}')" title="Block Transaction">
                                    <i class="fas fa-ban"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                // Add hover effect for risk details
                row.addEventListener('mouseenter', () => {
                    if (tx.anomaly_flags && tx.anomaly_flags !== 'None detected') {
                        row.title = `Risk Factors: ${tx.anomaly_flags}`;
                    }
                });
                
                tableBody.appendChild(row);
            });
        }

        function updateDetailedAnalysis(data) {
            // Create detailed analysis section if it doesn't exist
            let analysisSection = document.getElementById('detailedAnalysis');
            if (!analysisSection) {
                analysisSection = document.createElement('div');
                analysisSection.id = 'detailedAnalysis';
                analysisSection.className = 'row mt-4';
                document.querySelector('.dashboard-container').appendChild(analysisSection);
            }
            
            const riskDistribution = calculateRiskDistribution(data.recent_transactions || []);
            const industryAnalysis = calculateIndustryAnalysis(data.recent_transactions || []);
            
            analysisSection.innerHTML = `
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5><i class="fas fa-chart-bar"></i> Risk Level Distribution</h5>
                        <div id="riskLevelChart"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-card">
                        <h5><i class="fas fa-industry"></i> Industry Analysis</h5>
                        <div id="industryChart"></div>
                    </div>
                </div>
                <div class="col-12 mt-3">
                    <div class="chart-card">
                        <h5><i class="fas fa-clock"></i> Transaction Timeline</h5>
                        <div id="timelineChart"></div>
                    </div>
                </div>
            `;
            
            // Render new charts
            renderRiskLevelChart(riskDistribution);
            renderIndustryChart(industryAnalysis);
            renderTimelineChart(data.recent_transactions || []);
        }

        function calculateRiskDistribution(transactions) {
            const distribution = { low: 0, medium: 0, high: 0 };
            transactions.forEach(tx => {
                if (tx.risk_score > 70) distribution.high++;
                else if (tx.risk_score > 40) distribution.medium++;
                else distribution.low++;
            });
            return distribution;
        }

        function calculateIndustryAnalysis(transactions) {
            const industries = {};
            transactions.forEach(tx => {
                const industry = tx.industry_type || 'general';
                if (!industries[industry]) {
                    industries[industry] = { count: 0, totalRisk: 0 };
                }
                industries[industry].count++;
                industries[industry].totalRisk += tx.risk_score || 0;
            });
            
            Object.keys(industries).forEach(key => {
                industries[key].avgRisk = industries[key].totalRisk / industries[key].count;
            });
            
            return industries;
        }

        function showSuccessMessage(message) {
            // Create or update a success alert
            const alertContainer = document.querySelector('.alert-container') || createAlertContainer();
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function refreshChartsWithData(data) {
            console.log('🔄 refreshChartsWithData called with:', data);
            
            // Update existing charts with new data if available
            if (data && data.chart_data) {
                console.log('📊 Chart data found:', data.chart_data);
                try {
                    // Update fraud trends chart
                    updateFraudTrendsChart(data.chart_data);
                    
                    // Update risk distribution chart
                    updateRiskDistributionChart(data.chart_data);
                    
                } catch (error) {
                    console.error('❌ Could not update charts:', error);
                }
            } else {
                console.error('❌ No data or chart_data provided to refreshChartsWithData:', {
                    data_exists: !!data,
                    chart_data_exists: !!(data && data.chart_data)
                });
            }
        }

        function updateFraudTrendsChart(chartData) {
            console.log('🔍 updateFraudTrendsChart called with data:', chartData);
            
            // Check if chart container is visible
            const chartContainer = document.querySelector("#fraudTrendsChart");
            if (!chartContainer) {
                console.error('❌ Chart container #fraudTrendsChart not found');
                return;
            }
            
            const analysisSection = document.getElementById('analysisResults');
            if (analysisSection && analysisSection.style.display === 'none') {
                console.warn('⚠️ Analysis section is hidden, making it visible first');
                analysisSection.style.display = 'block';
            }
            
            if (chartData && chartData.fraud_trends) {
                const fraudTrendsData = chartData.fraud_trends;
                console.log('📊 Fraud trends data:', fraudTrendsData);
                
                // Validate we have the required data
                if (!fraudTrendsData.months || !fraudTrendsData.total_transactions || !fraudTrendsData.flagged_transactions) {
                    console.error('❌ Missing required fraud trends data:', {
                        months: fraudTrendsData.months,
                        total_transactions: fraudTrendsData.total_transactions,
                        flagged_transactions: fraudTrendsData.flagged_transactions
                    });
                    return;
                }
                
                // Update the chart with new data
                // Calculate responsive configuration based on data size
                const numDataPoints = fraudTrendsData.months ? fraudTrendsData.months.length : 0;
                const originalDataCount = fraudTrendsData.original_date_count || numDataPoints;
                const isSampled = fraudTrendsData.is_sampled || false;
                const isExtended = fraudTrendsData.is_extended || false;
                
                // Determine optimal chart settings based on data characteristics
                let labelRotation = 0;
                let fontSize = '12px';
                let tickAmount;
                let subtitleText = '';
                
                if (isExtended && originalDataCount <= 1) {
                    // For very small datasets that we've extended
                    subtitleText = originalDataCount === 0 ? 
                        'No date-specific data available - showing current upload summary' :
                        `Single date dataset - extended view for visualization`;
                    fontSize = '12px';
                } else if (isSampled) {
                    // For large datasets that we've sampled
                    subtitleText = `Showing ${numDataPoints} of ${originalDataCount} dates (sampled for clarity)`;
                    
                    if (originalDataCount > 50) {
                        labelRotation = -45;
                        fontSize = '10px';
                        tickAmount = Math.min(12, numDataPoints);
                    } else if (originalDataCount > 30) {
                        labelRotation = -30;
                        fontSize = '11px';
                        tickAmount = Math.min(15, numDataPoints);
                    }
                } else if (numDataPoints > 15) {
                    labelRotation = -15;
                    fontSize = '11px';
                } else if (numDataPoints > 10) {
                    labelRotation = 0;
                    fontSize = '12px';
                }
                
                const newOptions = {
                    series: [{
                        name: 'Total Transactions',
                        data: fraudTrendsData.total_transactions
                    }, {
                        name: 'Flagged Transactions',
                        data: fraudTrendsData.flagged_transactions
                    }],
                    xaxis: {
                        categories: fraudTrendsData.months,
                        labels: {
                            rotate: labelRotation,
                            rotateAlways: labelRotation !== 0,
                            hideOverlappingLabels: true,
                            maxHeight: labelRotation !== 0 ? 100 : 60,
                            style: {
                                fontSize: fontSize,
                                fontWeight: 500
                            },
                            trim: true,
                            formatter: function(val) {
                                return val;
                            }
                        },
                        tickAmount: tickAmount,
                        axisBorder: {
                            show: true,
                            color: '#e5eaef'
                        },
                        axisTicks: {
                            show: true,
                            color: '#e5eaef'
                        },
                        // Add subtitle if needed
                        title: subtitleText ? {
                            text: subtitleText,
                            style: {
                                fontSize: '10px',
                                color: '#666'
                            }
                        } : undefined
                    }
                };
                
                console.log('📈 Updating chart with options:', newOptions);
                
                // Update the existing chart
                if (window.fraudTrendsChart) {
                    console.log('✅ Updating existing chart');
                    try {
                        window.fraudTrendsChart.updateOptions(newOptions, true, true);
                    } catch (error) {
                        console.warn('⚠️ Failed to update chart, recreating it:', error);
                        window.fraudTrendsChart.destroy();
                        window.fraudTrendsChart = null;
                    }
                }
                
                if (!window.fraudTrendsChart) {
                    console.log('🆕 Creating new chart');
                    // If chart doesn't exist, create it
                    const fullOptions = {
                        ...newOptions,
                        chart: {
                            height: 350,
                            type: 'area',
                            toolbar: {
                                show: false
                            },
                            zoom: {
                                enabled: numDataPoints > 20
                            }
                        },
                        colors: ['#5d87ff', '#fa896b'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shadeIntensity: 1,
                                opacityFrom: 0.7,
                                opacityTo: 0.3
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            curve: 'smooth',
                            width: 2
                        },
                        grid: {
                            borderColor: '#e5eaef'
                        }
                    };
                    
                    window.fraudTrendsChart = new ApexCharts(document.querySelector("#fraudTrendsChart"), fullOptions);
                    window.fraudTrendsChart.render();
                    console.log('✅ New chart created and rendered');
                }
                
                console.log('✅ Updated fraud trends chart with uploaded data');
            } else {
                console.error('❌ No chart data or fraud_trends data provided:', chartData);
            }
        }

        function updateRiskDistributionChart(chartData) {
            // Implementation for updating the risk distribution chart
            if (chartData.risk_distribution) {
                const labels = Object.keys(chartData.risk_distribution);
                const values = Object.values(chartData.risk_distribution);
                
                // Update the existing chart or create new one
                console.log('Updating risk distribution chart with real data');
            }
        }

        // AI Assistant enhanced functionality
        document.getElementById('aiAssistant').addEventListener('click', function() {
            showAIAssistant();
        });

        function showAIAssistant() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'aiAssistantModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-robot me-2"></i>
                                AI Fraud Detection Assistant
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="ai-chat-container" style="height: 400px; overflow-y: auto; border: 1px solid #e5eaef; border-radius: 8px; padding: 15px;">
                                <div class="ai-message">
                                    <div class="d-flex mb-3">
                                        <div class="ai-avatar me-3">
                                            <i class="fas fa-robot text-primary"></i>
                                        </div>
                                        <div class="ai-content">
                                            <div class="fw-bold text-primary mb-1">FraudGuard AI</div>
                                            <div class="ai-text">
                                                Hello! I'm your AI fraud detection assistant. I can help you:
                                                <ul class="mt-2 mb-0">
                                                    <li>Analyze transaction patterns</li>
                                                    <li>Explain risk scores and anomalies</li>
                                                    <li>Provide fraud prevention recommendations</li>
                                                    <li>Help optimize your security settings</li>
                                                </ul>
                                                What would you like to know about your transactions?
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-input-container mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Ask me about your fraud detection results..." id="aiChatInput">
                                    <button class="btn btn-primary" type="button" onclick="sendAIMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="ai-suggestions mt-3">
                                <small class="text-muted">Quick questions:</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askAI('Why are some transactions flagged as high risk?')">
                                        Why high risk?
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askAI('How can I reduce false positives?')">
                                        Reduce false positives
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askAI('What patterns should I watch for?')">
                                        Pattern analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            // Focus on input
            modal.querySelector('#aiChatInput').focus();
            
            // Handle enter key
            modal.querySelector('#aiChatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
            
            // Clean up modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            
            if (message) {
                askAI(message);
                input.value = '';
            }
        }

        function askAI(question) {
            const chatContainer = document.querySelector('.ai-chat-container');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'ai-message user-message';
            userMessage.innerHTML = `
                <div class="d-flex mb-3 justify-content-end">
                    <div class="ai-content me-3">
                        <div class="user-text bg-primary text-white p-2 rounded">
                            ${question}
                        </div>
                    </div>
                    <div class="ai-avatar">
                        <i class="fas fa-user text-secondary"></i>
                    </div>
                </div>
            `;
            chatContainer.appendChild(userMessage);
            
            // Add AI response (simulated)
            setTimeout(() => {
                const aiResponse = getAIResponse(question);
                const aiMessage = document.createElement('div');
                aiMessage.className = 'ai-message';
                aiMessage.innerHTML = `
                    <div class="d-flex mb-3">
                        <div class="ai-avatar me-3">
                            <i class="fas fa-robot text-primary"></i>
                        </div>
                        <div class="ai-content">
                            <div class="fw-bold text-primary mb-1">FraudGuard AI</div>
                            <div class="ai-text">
                                ${aiResponse}
                            </div>
                        </div>
                    </div>
                `;
                chatContainer.appendChild(aiMessage);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1000);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function getAIResponse(question) {
            const lowerQuestion = question.toLowerCase();
            
            if (lowerQuestion.includes('high risk') || lowerQuestion.includes('flagged')) {
                return `Transactions are flagged as high risk based on several factors:
                <ul class="mt-2">
                    <li><strong>Unusual amounts:</strong> Very high or very low transaction amounts</li>
                    <li><strong>Time patterns:</strong> Transactions at unusual hours (late night/early morning)</li>
                    <li><strong>Geographic anomalies:</strong> Mismatched location data</li>
                    <li><strong>Velocity patterns:</strong> Too many transactions in a short time</li>
                    <li><strong>Customer behavior:</strong> Unusual patterns for specific customers</li>
                </ul>
                Review the "Risk Factors" section in your analysis for specific details about flagged transactions.`;
            }
            
            if (lowerQuestion.includes('false positive') || lowerQuestion.includes('reduce')) {
                return `To reduce false positives, consider these strategies:
                <ul class="mt-2">
                    <li><strong>Tune thresholds:</strong> Adjust risk score thresholds based on your business</li>
                    <li><strong>Whitelist customers:</strong> Mark trusted customers for reduced scrutiny</li>
                    <li><strong>Industry settings:</strong> Use industry-specific fraud rules</li>
                    <li><strong>Time-based rules:</strong> Adjust for your business hours</li>
                    <li><strong>Regular review:</strong> Continuously review and refine rules</li>
                </ul>
                Monitor your fraud rate vs. false positive rate to find the optimal balance.`;
            }
            
            if (lowerQuestion.includes('pattern') || lowerQuestion.includes('watch')) {
                return `Key patterns to monitor for fraud:
                <ul class="mt-2">
                    <li><strong>Card testing:</strong> Multiple small amounts (often $1-5)</li>
                    <li><strong>Round numbers:</strong> Transactions ending in .00</li>
                    <li><strong>Velocity attacks:</strong> Rapid successive transactions</li>
                    <li><strong>Geographic jumps:</strong> Impossible travel times between locations</li>
                    <li><strong>Off-hours activity:</strong> Unusual time patterns</li>
                    <li><strong>Email patterns:</strong> Disposable or suspicious email addresses</li>
                </ul>
                Check your "Time Analysis" and "Geographic Analysis" sections for these patterns.`;
            }
            
            if (lowerQuestion.includes('improve') || lowerQuestion.includes('better')) {
                return `To improve your fraud detection:
                <ul class="mt-2">
                    <li><strong>Collect more data:</strong> IP addresses, device fingerprints, billing info</li>
                    <li><strong>Machine learning:</strong> Use historical data to improve accuracy</li>
                    <li><strong>Real-time scoring:</strong> Implement dynamic risk assessment</li>
                    <li><strong>Customer profiling:</strong> Build behavioral profiles for users</li>
                    <li><strong>External data:</strong> Use blacklists and threat intelligence</li>
                </ul>
                The more quality data you have, the better the fraud detection becomes.`;
            }
            
            return `I'd be happy to help you with fraud detection questions! I can provide insights about:
            <ul class="mt-2">
                <li>Risk scoring and why transactions are flagged</li>
                <li>How to reduce false positives</li>
                <li>Fraud patterns to watch for</li>
                <li>Best practices for fraud prevention</li>
                <li>Interpreting your analysis results</li>
            </ul>
            Could you be more specific about what you'd like to know?`;
        }

        function renderRiskLevelChart(distribution) {
            const options = {
                series: [distribution.low, distribution.medium, distribution.high],
                chart: {
                    type: 'donut',
                    height: 300
                },
                colors: ['#13deb9', '#ffae1f', '#fa896b'],
                labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                legend: {
                    position: 'bottom'
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    formatter: function (w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val, opts) {
                        return opts.w.config.series[opts.seriesIndex];
                    }
                }
            };

            const chart = new ApexCharts(document.querySelector("#riskLevelChart"), options);
            chart.render();
        }

        function renderIndustryChart(industries) {
            const categories = Object.keys(industries);
            const counts = categories.map(cat => industries[cat].count);
            const avgRisks = categories.map(cat => industries[cat].avgRisk);

            const options = {
                series: [{
                    name: 'Transaction Count',
                    type: 'column',
                    data: counts
                }, {
                    name: 'Average Risk Score',
                    type: 'line',
                    data: avgRisks
                }],
                chart: {
                    height: 300,
                    type: 'line',
                    toolbar: { show: false }
                },
                stroke: {
                    width: [0, 4]
                },
                colors: ['#5d87ff', '#fa896b'],
                dataLabels: {
                    enabled: true,
                    enabledOnSeries: [1]
                },
                labels: categories.map(cat => cat.replace('_', ' ').toUpperCase()),
                xaxis: {
                    type: 'category'
                },
                yaxis: [{
                    title: {
                        text: 'Transaction Count',
                    },
                }, {
                    opposite: true,
                    title: {
                        text: 'Average Risk Score'
                    }
                }]
            };

            const chart = new ApexCharts(document.querySelector("#industryChart"), options);
            chart.render();
        }

        function renderTimelineChart(transactions) {
            // Group transactions by hour
            const hourlyData = Array.from({length: 24}, (_, i) => ({hour: i, count: 0, totalRisk: 0}));
            
            transactions.forEach(tx => {
                const hour = tx.hour || 12;
                if (hour >= 0 && hour < 24) {
                    hourlyData[hour].count++;
                    hourlyData[hour].totalRisk += tx.risk_score || 0;
                }
            });

            const options = {
                series: [{
                    name: 'Transactions',
                    data: hourlyData.map(d => d.count)
                }, {
                    name: 'Avg Risk Score',
                    data: hourlyData.map(d => d.count > 0 ? d.totalRisk / d.count : 0)
                }],
                chart: {
                    height: 350,
                    type: 'line',
                    toolbar: { show: false }
                },
                colors: ['#5d87ff', '#fa896b'],
                stroke: {
                    width: [3, 3],
                    curve: 'smooth'
                },
                xaxis: {
                    categories: hourlyData.map(d => `${d.hour}:00`),
                    title: { text: 'Hour of Day' }
                },
                yaxis: [{
                    title: { text: 'Transaction Count' }
                }, {
                    opposite: true,
                    title: { text: 'Average Risk Score' }
                }],
                legend: {
                    position: 'top'
                },
                grid: {
                    borderColor: '#e5eaef'
                }
            };

            const chart = new ApexCharts(document.querySelector("#timelineChart"), options);
            chart.render();
        }

        function viewTransactionDetails(transactionId, index) {
            // Find the transaction in the current analysis data
            let transaction = null;
            
            if (window.currentAnalysisData) {
                // First, try to find in recent_transactions
                if (window.currentAnalysisData.recent_transactions) {
                    transaction = window.currentAnalysisData.recent_transactions.find(tx => 
                        tx.transaction_id === transactionId
                    );
                }
                
                // If not found, try high_risk_transactions
                if (!transaction && window.currentAnalysisData.high_risk_transactions) {
                    transaction = window.currentAnalysisData.high_risk_transactions.find(tx => 
                        tx.transaction_id === transactionId
                    );
                }
                
                // If still not found and index is provided, try to get by index
                if (!transaction && typeof index !== 'undefined' && window.currentAnalysisData.recent_transactions) {
                    transaction = window.currentAnalysisData.recent_transactions[index];
                }
            }
            
            // Format the data for display
            const formatAmount = (amount) => {
                if (amount === null || amount === undefined || isNaN(amount)) return 'N/A';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            };
            
            const formatDate = (date) => {
                if (!date || date === 'N/A') return 'N/A';
                try {
                    return new Date(date).toLocaleDateString();
                } catch (e) {
                    return date;
                }
            };
            
            const formatTime = (time) => {
                if (!time || time === 'N/A') return 'N/A';
                return time;
            };
            
            const getRiskScoreColor = (score) => {
                if (score >= 70) return 'text-danger';
                if (score >= 40) return 'text-warning';
                return 'text-success';
            };
            
            const getSafetyLevelColor = (level) => {
                if (level === 'Needs Your Attention') return 'text-danger';
                if (level === 'Watch Closely') return 'text-warning';
                return 'text-success';
            };
            
            // Create modal for transaction details
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'transactionDetailModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Transaction Details - ${transactionId}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Information</h6>
                                    <p><strong>Transaction ID:</strong> ${transactionId}</p>
                                    <p><strong>Amount:</strong> ${formatAmount(transaction?.amount)}</p>
                                    <p><strong>Date:</strong> ${formatDate(transaction?.transaction_date || transaction?.date)}</p>
                                    <p><strong>Time:</strong> ${formatTime(transaction?.transaction_time || transaction?.time)}</p>
                                    <p><strong>Customer:</strong> ${transaction?.customer_name || 'N/A'}</p>
                                    <p><strong>Merchant:</strong> ${transaction?.merchant_name || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Risk Assessment</h6>
                                    <p><strong>Risk Score:</strong> <span class="${getRiskScoreColor(transaction?.risk_score)}">${transaction?.risk_score || 'N/A'}</span></p>
                                    <p><strong>Safety Level:</strong> <span class="${getSafetyLevelColor(transaction?.safety_level)}">${transaction?.safety_level || 'N/A'}</span></p>
                                    <p><strong>Risk Factors:</strong> ${transaction?.anomaly_flags || 'None detected'}</p>
                                </div>
                            </div>
                            ${transaction?.customer_email || transaction?.customer_phone || transaction?.customer_city ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Customer Information</h6>
                                    ${transaction?.customer_email ? `<p><strong>Email:</strong> ${transaction.customer_email}</p>` : ''}
                                    ${transaction?.customer_phone ? `<p><strong>Phone:</strong> ${transaction.customer_phone}</p>` : ''}
                                    ${transaction?.customer_city ? `<p><strong>Location:</strong> ${transaction.customer_city}${transaction?.customer_state ? ', ' + transaction.customer_state : ''}${transaction?.customer_zip_code ? ' ' + transaction.customer_zip_code : ''}</p>` : ''}
                                    ${transaction?.customer_ip_address ? `<p><strong>IP Address:</strong> ${transaction.customer_ip_address}</p>` : ''}
                                </div>
                            </div>
                            ` : ''}
                            <div class="mt-3">
                                <h6>Actions</h6>
                                <button class="btn btn-success me-2" onclick="markTransactionSafe('${transactionId}')">Mark as Safe</button>
                                <button class="btn btn-warning me-2" onclick="flagTransaction('${transactionId}')">Request Verification</button>
                                <button class="btn btn-danger" onclick="blockTransaction('${transactionId}')">Block Transaction</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            // Clean up modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        function markTransactionSafe(transactionId) {
            if (confirm(`Mark transaction ${transactionId} as safe?`)) {
                showAlert('Transaction marked as safe', 'success');
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('transactionDetailModal'));
                if (modal) modal.hide();
            }
        }

        function flagTransaction(transactionId) {
            if (confirm(`Flag transaction ${transactionId} for manual review?`)) {
                showAlert('Transaction flagged for review', 'warning');
            }
        }

        function blockTransaction(transactionId) {
            if (confirm(`Block transaction ${transactionId}? This action cannot be undone.`)) {
                showAlert('Transaction blocked successfully', 'danger');
            }
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.querySelector('.alert-container') || createAlertContainer();
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function showAnalysisResults(data) {
            const analysisSection = document.getElementById('analysisResults');
            const exportBtn = document.getElementById('exportBtn');
            
            if (analysisSection) {
                analysisSection.style.display = 'block';
                exportBtn.style.display = 'inline-block';
                
                // Store data for export
                window.currentAnalysisData = data;
                
                // Update analysis content
                updateAnalysisContent(data);
            }
        }

        function updateAnalysisContent(data) {
            const transactions = data.recent_transactions || [];
            
            // Update risk factors
            const riskFactors = calculateRiskFactors(transactions);
            updateRiskFactorsDisplay(riskFactors);
            
            // Update recommendations
            updateRecommendations(data.summary);
            
            // Render mini charts
            renderMiniRiskChart(transactions);
            
            // Update simplified charts for small merchants
            updateSimplifiedCharts(data);
        }
        
        function updateSimplifiedCharts(data) {
            const transactions = data.recent_transactions || [];
            const summary = data.summary || {};
            
            // Update Safety Score Meter
            updateSafetyScoreMeter(summary);
            
            // Update Safety Breakdown Chart
            updateSafetyBreakdownChart(summary);
            
            // Update Time Risk Chart
            updateTimeRiskChart(transactions);
            
            // Update Amount Risk Chart
            updateAmountRiskChart(transactions);
            
            // Update Action Cards
            updateActionCards(summary);
            
            // Update detailed transactions list with filtering
            updateDetailedTransactionsList(transactions);
        }
        
        function updateSafetyScoreMeter(summary) {
            const total = summary.total_transactions || 1;
            const safe = summary.safe_payments || 0;
            const watch = summary.watch_closely || 0;
            const risk = summary.needs_attention || 0;
            const moneyAtRisk = summary.money_at_risk || 0;
            
            // Enhanced safety score calculation
            // Base score from transaction safety (weighted by importance)
            const safetyPercentage = Math.round((safe / total) * 100);
            
            // Adjusted score based on risk factors
            let adjustedScore = safetyPercentage;
            
            // Penalty for high-risk transactions (more severe penalty)
            const riskPenalty = Math.min(risk * 5, 30); // Max 30 point penalty
            adjustedScore -= riskPenalty;
            
            // Penalty for watch transactions (moderate penalty)
            const watchPenalty = Math.min(watch * 2, 15); // Max 15 point penalty
            adjustedScore -= watchPenalty;
            
            // Penalty for high money at risk (financial impact)
            const moneyPenalty = Math.min(Math.floor(moneyAtRisk / 1000) * 2, 20); // Max 20 point penalty
            adjustedScore -= moneyPenalty;
            
            // Ensure score is within 0-100 range
            const finalScore = Math.max(0, Math.min(100, adjustedScore));
            
            // Determine color based on final score
            let scoreColor = '#fa896b'; // Red (danger)
            if (finalScore >= 85) {
                scoreColor = '#13deb9'; // Green (success)
            } else if (finalScore >= 70) {
                scoreColor = '#ffae1f'; // Yellow (warning)
            } else if (finalScore >= 50) {
                scoreColor = '#ff9f43'; // Orange (caution)
            }
            
            const options = {
                series: [finalScore],
                chart: {
                    height: 200,
                    type: 'radialBar',
                },
                colors: [scoreColor],
                plotOptions: {
                    radialBar: {
                        hollow: {
                            size: '60%',
                        },
                        track: {
                            background: '#f1f5f9',
                            strokeWidth: '100%',
                            margin: 5,
                        },
                        dataLabels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '14px',
                                fontWeight: 500,
                                color: '#64748b',
                                offsetY: 25,
                                formatter: function() {
                                    return 'Safety Score';
                                }
                            },
                            value: {
                                fontSize: '28px',
                                fontWeight: 'bold',
                                color: scoreColor,
                                offsetY: -10,
                                formatter: function (val) {
                                    return Math.round(val);
                                }
                            }
                        }
                    }
                },
                stroke: {
                    lineCap: 'round'
                },
                labels: ['Safety Score'],
            };

            const chartElement = document.querySelector("#safetyScoreMeter");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear previous chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
            
            // Update safety text with enhanced messaging
            const textElement = document.querySelector("#safetyScoreText");
            if (textElement) {
                let status, message, colorClass, icon;
                
                if (finalScore >= 85) {
                    status = "Excellent";
                    message = "Your payment security is outstanding";
                    colorClass = "text-success";
                    icon = "fas fa-shield-alt";
                } else if (finalScore >= 70) {
                    status = "Good";
                    message = "Generally secure with minor concerns";
                    colorClass = "text-warning";
                    icon = "fas fa-shield-halved";
                } else if (finalScore >= 50) {
                    status = "Fair";
                    message = "Some security issues need attention";
                    colorClass = "text-warning";
                    icon = "fas fa-exclamation-triangle";
                } else {
                    status = "Needs Attention";
                    message = "Multiple security concerns detected";
                    colorClass = "text-danger";
                    icon = "fas fa-shield-virus";
                }
                
                // Add detailed breakdown
                let breakdown = [];
                if (risk > 0) {
                    breakdown.push(`${risk} high-risk transactions`);
                }
                if (watch > 0) {
                    breakdown.push(`${watch} need monitoring`);
                }
                if (moneyAtRisk > 0) {
                    breakdown.push(`$${moneyAtRisk.toLocaleString()} at risk`);
                }
                
                const breakdownText = breakdown.length > 0 ? 
                    `<small class="text-muted d-block mt-1">${breakdown.join(', ')}</small>` : 
                    '';
                
                // Add critical animation class for very low scores
                const criticalClass = finalScore < 30 ? 'safety-score-critical' : '';
                
                textElement.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center mb-2 ${criticalClass}">
                        <i class="${icon} me-2 ${colorClass}"></i>
                        <h4 class="mb-0 ${colorClass}">${status}</h4>
                    </div>
                    <p class="text-muted mb-1">${message}</p>
                    ${breakdownText}
                    
                    <!-- Inline Score Reference Bar -->
                    <div class="score-reference-bar mb-3">
                        <div class="score-bar-container">
                            <div class="score-bar">
                                <div class="score-segment score-danger" style="width: 49%"></div>
                                <div class="score-segment score-fair" style="width: 20%"></div>
                                <div class="score-segment score-good" style="width: 15%"></div>
                                <div class="score-segment score-excellent" style="width: 16%"></div>
                            </div>
                            <div class="score-indicator" style="left: ${finalScore}%">
                                <div class="score-pointer"></div>
                                <small class="score-value">${Math.round(finalScore)}</small>
                            </div>
                        </div>
                        <div class="score-labels d-flex justify-content-between mt-1">
                            <small class="text-danger">0</small>
                            <small class="text-warning">50</small>
                            <small class="text-info">70</small>
                            <small class="text-success">85</small>
                            <small class="text-success">100</small>
                        </div>
                    </div>
                    
                    <div class="safety-score-info">
                        <div class="safety-score-breakdown">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Safe Transactions:</small>
                                <small class="fw-bold text-success">${safe}/${total}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Safety Rate:</small>
                                <small class="fw-bold">${safetyPercentage}%</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Initialize tooltips
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }
            }
        }
        
        function updateSafetyBreakdownChart(summary) {
            const safe = summary.safe_payments || 0;
            const watch = summary.watch_closely || 0;
            const risk = summary.needs_attention || 0;
            const total = safe + watch + risk || 1;
            
            const options = {
                series: [safe, watch, risk],
                chart: {
                    type: 'donut',
                    height: 200
                },
                colors: ['#13deb9', '#ffae1f', '#fa896b'],
                labels: ['Safe', 'Watch', 'Risk'],
                legend: {
                    show: false
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    formatter: function () {
                                        return total;
                                    }
                                }
                            }
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            height: 150
                        }
                    }
                }]
            };

            const chartElement = document.querySelector("#safetyBreakdownChart");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear previous chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
            
            // Update percentages
            const safePercent = Math.round((safe / total) * 100);
            const watchPercent = Math.round((watch / total) * 100);
            const riskPercent = Math.round((risk / total) * 100);
            
            document.getElementById('safePercentage').textContent = safePercent + '%';
            document.getElementById('watchPercentage').textContent = watchPercent + '%';
            document.getElementById('riskPercentage').textContent = riskPercent + '%';
        }
        
        function updateTimeRiskChart(transactions) {
            // Group transactions by hour and calculate risk levels
            const hourlyData = {};
            
            transactions.forEach(tx => {
                const hour = tx.hour || 12; // Default to noon if no hour data
                const riskLevel = tx.safety_level || 'Safe';
                
                if (!hourlyData[hour]) {
                    hourlyData[hour] = { safe: 0, risk: 0 };
                }
                
                if (riskLevel === 'Needs Your Attention') {
                    hourlyData[hour].risk++;
                } else {
                    hourlyData[hour].safe++;
                }
            });
            
            // Create time labels and data
            const timeLabels = [];
            const riskCounts = [];
            const safeCounts = [];
            
            // Fill in 24 hours
            for (let hour = 0; hour < 24; hour++) {
                const data = hourlyData[hour] || { safe: 0, risk: 0 };
                const timeLabel = hour === 0 ? '12 AM' : 
                                hour < 12 ? `${hour} AM` : 
                                hour === 12 ? '12 PM' : 
                                `${hour - 12} PM`;
                                
                timeLabels.push(timeLabel);
                riskCounts.push(data.risk);
                safeCounts.push(data.safe);
            }
            
            // Only show hours with data to avoid clutter
            const filteredData = timeLabels.map((label, index) => ({
                label,
                risk: riskCounts[index],
                safe: safeCounts[index],
                total: riskCounts[index] + safeCounts[index]
            })).filter(item => item.total > 0);
            
            const options = {
                series: [{
                    name: 'Risky Transactions',
                    data: filteredData.map(item => item.risk)
                }, {
                    name: 'Safe Transactions',
                    data: filteredData.map(item => item.safe)
                }],
                chart: {
                    type: 'bar',
                    height: 220,
                    stacked: true,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#fa896b', '#13deb9'],
                xaxis: {
                    categories: filteredData.map(item => item.label),
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Number of Transactions'
                    }
                },
                legend: {
                    position: 'top',
                    fontSize: '12px'
                },
                dataLabels: {
                    enabled: false
                },
                grid: {
                    borderColor: '#e5eaef'
                }
            };

            const chartElement = document.querySelector("#timeRiskChart");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear previous chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
        }
        
        function updateAmountRiskChart(transactions) {
            // Group transactions by amount ranges
            const ranges = [
                { label: '$0-$50', min: 0, max: 50 },
                { label: '$50-$200', min: 50, max: 200 },
                { label: '$200-$500', min: 200, max: 500 },
                { label: '$500-$1K', min: 500, max: 1000 },
                { label: '$1K+', min: 1000, max: Infinity }
            ];
            
            const rangeData = ranges.map(range => {
                const inRange = transactions.filter(tx => {
                    const amount = parseFloat(tx.amount) || 0;
                    return amount >= range.min && amount < range.max;
                });
                
                const risky = inRange.filter(tx => tx.safety_level === 'Needs Your Attention').length;
                const total = inRange.length;
                
                return {
                    label: range.label,
                    risky,
                    total,
                    percentage: total > 0 ? Math.round((risky / total) * 100) : 0
                };
            }).filter(item => item.total > 0); // Only show ranges with data
            
            const options = {
                series: [{
                    name: 'Risk Percentage',
                    data: rangeData.map(item => item.percentage)
                }],
                chart: {
                    type: 'bar',
                    height: 220,
                    toolbar: {
                        show: false
                    }
                },
                colors: ['#5d87ff'],
                xaxis: {
                    categories: rangeData.map(item => item.label),
                    labels: {
                        style: {
                            fontSize: '11px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Risk %'
                    },
                    max: 100
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val + '%'
                    }
                },
                grid: {
                    borderColor: '#e5eaef'
                }
            };

            const chartElement = document.querySelector("#amountRiskChart");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear previous chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
            
            // Update insight text
            const insight = document.querySelector("#amountRiskInsight");
            if (insight && rangeData.length > 0) {
                const highestRisk = rangeData.reduce((max, item) => 
                    item.percentage > max.percentage ? item : max, rangeData[0]);
                
                if (highestRisk.percentage > 0) {
                    insight.textContent = `${highestRisk.label} transactions have the highest risk (${highestRisk.percentage}%)`;
                } else {
                    insight.textContent = "All transaction amounts look safe!";
                }
            }
        }
        
        function updateActionCards(summary) {
            document.getElementById('reviewCount').textContent = summary.needs_attention || 0;
            document.getElementById('contactCount').textContent = Math.min(summary.needs_attention || 0, 5);
        }
        
        function updateDetailedTransactionsList(transactions) {
            const container = document.getElementById('detailedTransactionsList');
            if (!container) return;
            
            // Sort transactions by risk score (highest first)
            const sortedTransactions = [...transactions].sort((a, b) => {
                const scoreA = parseFloat(a.risk_score) || 0;
                const scoreB = parseFloat(b.risk_score) || 0;
                return scoreB - scoreA;
            });
            
            container.innerHTML = sortedTransactions.map((tx, index) => {
                const riskScore = parseFloat(tx.risk_score) || 0;
                const amount = parseFloat(tx.amount) || 0;
                const safetyLevel = tx.safety_level || 'Safe';
                
                let badgeClass = 'bg-success';
                let badgeText = 'Safe';
                let iconClass = 'fas fa-check-circle text-success';
                
                if (safetyLevel === 'Needs Your Attention') {
                    badgeClass = 'bg-danger';
                    badgeText = 'Needs Review';
                    iconClass = 'fas fa-exclamation-triangle text-danger';
                } else if (safetyLevel === 'Watch Closely') {
                    badgeClass = 'bg-warning';
                    badgeText = 'Watch';
                    iconClass = 'fas fa-eye text-warning';
                }
                
                return `
                    <div class="transaction-item border-bottom py-3" data-safety="${safetyLevel}">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="${iconClass} fa-lg"></i>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">${formatCurrency(amount)}</h6>
                                <small class="text-muted">${tx.transaction_id || 'N/A'}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                            <div class="col-md-2">
                                <div class="customer-info">
                                    <div class="fw-bold">${tx.customer_name || 'Unknown'}</div>
                                    <small class="text-muted">${tx.customer_city || ''}</small>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">
                                    ${tx.transaction_date || 'N/A'}<br>
                                    ${tx.transaction_time || 'N/A'}
                                </small>
                            </div>
                            <div class="col-md-2 text-end">
                                ${safetyLevel === 'Needs Your Attention' ? 
                                    `<button class="btn btn-sm btn-outline-primary" onclick="viewTransactionDetails('${tx.transaction_id}', ${index})">
                                        Review
                                    </button>` : 
                                    `<small class="text-success">✓ Looks Good</small>`
                                }
                            </div>
                        </div>
                        ${safetyLevel === 'Needs Your Attention' && tx.anomaly_flags && tx.anomaly_flags !== 'None detected' ? 
                            `<div class="row mt-2">
                                <div class="col-md-11 offset-md-1">
                                    <div class="alert alert-warning py-2 mb-0">
                                        <small><i class="fas fa-info-circle me-1"></i> ${tx.anomaly_flags}</small>
                                    </div>
                                </div>
                            </div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }
        
        // Transaction filtering functions
        function filterTransactions(type) {
            const items = document.querySelectorAll('.transaction-item');
            const buttons = document.querySelectorAll('[onclick^="filterTransactions"]');
            
            // Update button states
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            items.forEach(item => {
                const safety = item.dataset.safety;
                let show = true;
                
                switch(type) {
                    case 'risk':
                        show = safety === 'Needs Your Attention';
                        break;
                    case 'safe':
                        show = safety === 'Safe';
                        break;
                    case 'all':
                    default:
                        show = true;
                        break;
                }
                
                item.style.display = show ? 'block' : 'none';
            });
        }
        
        // Action card functions
        function showHighRiskTransactions() {
            // Switch to details tab and filter to risk transactions
            switchAnalysisView('details');
            
            // Small delay to ensure tab is visible
            setTimeout(() => {
                filterTransactions('risk');
                document.querySelector('#analysisDetails').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        function showContactList() {
            // Create a modal with contact information for high-risk transactions
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'contactListModal';
            
            // Get high-risk transactions from current data
            const highRiskTransactions = window.currentAnalysisData?.recent_transactions?.filter(tx => 
                tx.safety_level === 'Needs Your Attention'
            ).slice(0, 5) || [];
            
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-phone text-info me-2"></i>
                                Customer Contact List for Verification
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-3">Contact these customers to verify their high-risk transactions:</p>
                            ${highRiskTransactions.length > 0 ? 
                                highRiskTransactions.map(tx => `
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="row align-items-center">
                                                <div class="col-md-3">
                                                    <strong>${tx.customer_name || 'Unknown'}</strong>
                                                </div>
                                                <div class="col-md-3">
                                                    <span class="text-primary">${tx.customer_phone || 'No phone'}</span>
                                                </div>
                                                <div class="col-md-3">
                                                    <span class="text-success">${formatCurrency(tx.amount || 0)}</span>
                                                </div>
                                                <div class="col-md-3 text-end">
                                                    <small class="text-muted">${tx.transaction_id || ''}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No high-risk transactions found!</div>'
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="exportContactList()">Export List</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }
        
        function enableProtection() {
            showAlert('Real-time monitoring enabled! We\'ll alert you to suspicious activity.', 'success');
        }
        
        function exportContactList() {
            const highRiskTransactions = window.currentAnalysisData?.recent_transactions?.filter(tx => 
                tx.safety_level === 'Needs Your Attention'
            ) || [];
            
            const csvContent = [
                ['Customer Name', 'Phone', 'Email', 'Amount', 'Transaction ID', 'Date'],
                ...highRiskTransactions.map(tx => [
                    tx.customer_name || 'Unknown',
                    tx.customer_phone || 'No phone',
                    tx.customer_email || 'No email',
                    tx.amount || 0,
                    tx.transaction_id || '',
                    tx.transaction_date || ''
                ])
            ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contact_list_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Contact list exported successfully', 'success');
        }

        function calculateRiskFactors(transactions) {
            const factors = {};
            
            transactions.forEach(tx => {
                if (tx.anomaly_flags && tx.anomaly_flags !== 'None detected') {
                    const flags = tx.anomaly_flags.split(';');
                    flags.forEach(flag => {
                        const trimmed = flag.trim();
                        if (trimmed) {
                            factors[trimmed] = (factors[trimmed] || 0) + 1;
                        }
                    });
                }
            });
            
            // Convert to sorted array
            return Object.entries(factors)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([factor, count]) => ({
                    factor,
                    count,
                    percentage: Math.round((count / transactions.length) * 100)
                }));
        }

        function updateRiskFactorsDisplay(riskFactors) {
            const container = document.getElementById('riskFactors');
            if (!container) return;
            
            container.innerHTML = riskFactors.map(rf => `
                <div class="risk-factor-item mb-2">
                    <span class="badge ${rf.percentage > 20 ? 'bg-danger' : rf.percentage > 10 ? 'bg-warning' : 'bg-info'}">${rf.factor}</span>
                    <span class="float-end">${rf.percentage}%</span>
                </div>
            `).join('');
        }

        function updateRecommendations(summary) {
            const container = document.querySelector('.recommendations');
            if (!container) return;
            
            const recommendations = [];
            
            if (summary.needs_attention > 0) {
                recommendations.push({
                    icon: 'fas fa-exclamation-triangle text-warning',
                    text: `Review ${summary.needs_attention} high-risk transactions`
                });
            }
            
            if (summary.money_at_risk > 1000) {
                recommendations.push({
                    icon: 'fas fa-phone text-info',
                    text: `Contact customers for verification (${formatCurrency(summary.money_at_risk)} at risk)`
                });
            }
            
            recommendations.push({
                icon: 'fas fa-shield-alt text-success',
                text: 'Enable real-time monitoring'
            });
            
            container.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item mb-2">
                    <i class="${rec.icon}"></i>
                    ${rec.text}
                </div>
            `).join('');
        }

        function renderMiniRiskChart(transactions) {
            const riskDistribution = calculateRiskDistribution(transactions);
            
            const options = {
                series: [riskDistribution.low, riskDistribution.medium, riskDistribution.high],
                chart: {
                    type: 'donut',
                    height: 200
                },
                colors: ['#13deb9', '#ffae1f', '#fa896b'],
                labels: ['Low', 'Medium', 'High'],
                legend: {
                    show: false
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '70%'
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                }
            };

            const chart = new ApexCharts(document.querySelector("#miniRiskChart"), options);
            chart.render();
        }

        function switchAnalysisView(viewType) {
            // Hide all tabs
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Show selected tab
            const targetTab = document.getElementById(`analysis${viewType.charAt(0).toUpperCase() + viewType.slice(1)}`);
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            
            // Update button states
            document.querySelectorAll('[onclick^="switchAnalysisView"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Create charts for patterns tab if selected and data is available
            if (viewType === 'patterns' && window.currentAnalysisData) {
                setTimeout(() => {
                    createPatternCharts(window.currentAnalysisData);
                }, 100);
            }
        }

        function createPatternCharts(data) {
            const transactions = data.recent_transactions || [];
            
            // Create time pattern chart
            createTimePatternChart(transactions);
            
            // Create amount pattern chart
            createAmountPatternChart(transactions);
        }

        function createTimePatternChart(transactions) {
            // Analyze transaction patterns by hour
            const hourlyData = Array.from({length: 24}, (_, i) => ({
                hour: i,
                count: 0,
                highRiskCount: 0,
                totalAmount: 0
            }));
            
            transactions.forEach(tx => {
                let hour;
                
                // Extract hour from transaction_time or use default
                if (tx.transaction_time) {
                    const timeStr = tx.transaction_time.toString();
                    if (timeStr.includes(':')) {
                        hour = parseInt(timeStr.split(':')[0]);
                    } else if (timeStr.length >= 2) {
                        hour = parseInt(timeStr.substring(0, 2));
                    }
                } else if (tx.hour !== undefined) {
                    hour = tx.hour;
                }
                
                // Default to a random business hour if no valid hour found
                if (hour === undefined || hour < 0 || hour > 23) {
                    hour = Math.floor(Math.random() * 12) + 9; // 9 AM to 8 PM
                }
                
                hourlyData[hour].count++;
                hourlyData[hour].totalAmount += parseFloat(tx.amount || 0);
                
                if (tx.risk_score > 70) {
                    hourlyData[hour].highRiskCount++;
                }
            });
            
            const options = {
                series: [{
                    name: 'Total Transactions',
                    type: 'column',
                    data: hourlyData.map(d => d.count)
                }, {
                    name: 'High Risk Transactions',
                    type: 'line',
                    data: hourlyData.map(d => d.highRiskCount)
                }],
                chart: {
                    height: 250,
                    type: 'line',
                    toolbar: { show: false }
                },
                stroke: {
                    width: [0, 4],
                    curve: 'smooth'
                },
                colors: ['#5d87ff', '#fa896b'],
                dataLabels: {
                    enabled: false
                },
                labels: hourlyData.map(d => `${d.hour.toString().padStart(2, '0')}:00`),
                xaxis: {
                    type: 'category',
                    title: {
                        text: 'Hour of Day'
                    },
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    }
                },
                yaxis: [{
                    title: {
                        text: 'Transaction Count'
                    }
                }, {
                    opposite: true,
                    title: {
                        text: 'High Risk Count'
                    }
                }],
                legend: {
                    position: 'top'
                },
                grid: {
                    borderColor: '#e5eaef'
                }
            };

            const chartElement = document.querySelector("#timePatternChart");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear existing chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
        }

        function createAmountPatternChart(transactions) {
            // Analyze transaction amounts and create distribution
            const amounts = transactions.map(tx => parseFloat(tx.amount || 0)).filter(amount => amount > 0);
            
            if (amounts.length === 0) {
                // Show empty state
                const chartElement = document.querySelector("#amountPatternChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="text-center text-muted mt-4"><i class="fas fa-chart-bar fa-2x mb-2"></i><br>No amount data available</div>';
                }
                return;
            }
            
            // Create amount ranges
            const maxAmount = Math.max(...amounts);
            const minAmount = Math.min(...amounts);
            const range = maxAmount - minAmount;
            
            // Create 10 buckets for amount distribution
            const buckets = 10;
            const bucketSize = range / buckets;
            const amountBuckets = Array.from({length: buckets}, (_, i) => ({
                min: minAmount + (i * bucketSize),
                max: minAmount + ((i + 1) * bucketSize),
                count: 0,
                highRiskCount: 0
            }));
            
            transactions.forEach(tx => {
                const amount = parseFloat(tx.amount || 0);
                if (amount > 0) {
                    const bucketIndex = Math.min(Math.floor((amount - minAmount) / bucketSize), buckets - 1);
                    amountBuckets[bucketIndex].count++;
                    
                    if (tx.risk_score > 70) {
                        amountBuckets[bucketIndex].highRiskCount++;
                    }
                }
            });
            
            const options = {
                series: [{
                    name: 'Transaction Count',
                    data: amountBuckets.map(bucket => bucket.count)
                }, {
                    name: 'High Risk Count',
                    data: amountBuckets.map(bucket => bucket.highRiskCount)
                }],
                chart: {
                    height: 250,
                    type: 'bar',
                    toolbar: { show: false }
                },
                colors: ['#5d87ff', '#fa896b'],
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    categories: amountBuckets.map(bucket => {
                        if (bucket.max < 1000) {
                            return `$${Math.round(bucket.min)}-$${Math.round(bucket.max)}`;
                        } else {
                            return `$${(bucket.min/1000).toFixed(1)}K-$${(bucket.max/1000).toFixed(1)}K`;
                        }
                    }),
                    title: {
                        text: 'Transaction Amount Range'
                    },
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Number of Transactions'
                    }
                },
                legend: {
                    position: 'top'
                },
                grid: {
                    borderColor: '#e5eaef'
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '70%'
                    }
                }
            };

            const chartElement = document.querySelector("#amountPatternChart");
            if (chartElement) {
                chartElement.innerHTML = ''; // Clear existing chart
                const chart = new ApexCharts(chartElement, options);
                chart.render();
            }
        }

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (window.currentAnalysisData) {
                exportAnalysisReport(window.currentAnalysisData);
            }
        });

        function exportAnalysisReport(data) {
            const csvContent = generateCSVReport(data);
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fraud_analysis_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Report exported successfully', 'success');
        }

        function generateCSVReport(data) {
            const headers = [
                'Transaction ID',
                'Amount',
                'Customer Name',
                'Risk Score',
                'Safety Level',
                'Industry Type',
                'Anomaly Flags',
                'Transaction Date',
                'Transaction Time'
            ];
            
            const rows = data.recent_transactions.map(tx => [
                tx.transaction_id || '',
                tx.amount || '',
                tx.customer_name || '',
                tx.risk_score || '',
                tx.safety_level || '',
                tx.industry_type || '',
                tx.anomaly_flags || '',
                tx.transaction_date || '',
                tx.transaction_time || ''
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            return csvContent;
        }

        function createAlertContainer() {
            const container = document.createElement('div');
            container.className = 'alert-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });
    </script>
</body>
</html>